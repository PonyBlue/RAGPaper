# RAG Paper System éƒ¨ç½²æŒ‡å—

## å¿«é€Ÿå¼€å§‹

### 1. ä½¿ç”¨Docker Composeï¼ˆæ¨èï¼‰

æœ€ç®€å•çš„éƒ¨ç½²æ–¹å¼ï¼Œä¸€é”®å¯åŠ¨æ•´ä¸ªç³»ç»Ÿã€‚

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd RAGPaper

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envæ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„APIå¯†é’¥

# 3. æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 5. åœæ­¢æœåŠ¡
docker-compose down
```

### 2. ä½¿ç”¨Dockerï¼ˆæ‰‹åŠ¨æ„å»ºï¼‰

```bash
# æ„å»ºé•œåƒ
docker build -t rag-paper:latest .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name rag-paper \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/chroma_db:/app/chroma_db \
  -v $(pwd)/logs:/app/logs \
  -v $(pwd)/.env:/app/.env \
  -p 8000:8000 \
  rag-paper:latest

# æŸ¥çœ‹æ—¥å¿—
docker logs -f rag-paper

# åœæ­¢å®¹å™¨
docker stop rag-paper
docker rm rag-paper
```

### 3. æœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# 1. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envæ–‡ä»¶

# 4. è¿è¡Œç³»ç»Ÿ
python main.py
```

---

## ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º`.env`æ–‡ä»¶å¹¶é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

```env
# ==================== LLMé…ç½® ====================
OPENAI_API_KEY=your_api_key_here
OPENAI_API_BASE=https://api.openai.com/v1
MODEL_NAME=gpt-3.5-turbo
TEMPERATURE=0.7

# ==================== Embeddingé…ç½® ====================
EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2

# ==================== æ£€ç´¢é…ç½® ====================
TOP_K=4
CHUNK_SIZE=1000
CHUNK_OVERLAP=200

# ==================== Reranké…ç½® ====================
USE_RERANK=true
RERANK_MODEL=BAAI/bge-reranker-base
RERANK_TOP_K=4
FETCH_K=20

# ==================== æ··åˆæ£€ç´¢é…ç½® ====================
USE_HYBRID=true
HYBRID_ALPHA=0.7
BM25_K1=1.5
BM25_B=0.75

# ==================== æŸ¥è¯¢æ”¹å†™é…ç½® ====================
USE_QUERY_REWRITE=false
REWRITE_STRATEGY=decompose
MERGE_STRATEGY=union
```

---

## æ•°æ®å‡†å¤‡

### ä¸Šä¼ PDFè®ºæ–‡

1. **æ‰‹åŠ¨ä¸Šä¼ **ï¼šå°†PDFæ–‡ä»¶æ”¾å…¥`data/`ç›®å½•

```bash
data/
â”œâ”€â”€ paper1.pdf
â”œâ”€â”€ paper2.pdf
â””â”€â”€ paper3.pdf
```

2. **æ„å»ºç´¢å¼•**ï¼šè¿è¡Œæ–‡æ¡£å¤„ç†è„šæœ¬

```bash
python demo_multi_papers.py
```

3. **éªŒè¯ç´¢å¼•**ï¼šæ£€æŸ¥`chroma_db/`ç›®å½•æ˜¯å¦ç”Ÿæˆ

---

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ·æŸ¥è¯¢ (User Query)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æŸ¥è¯¢æ”¹å†™ (Query Rewriting)           â”‚
â”‚  - æŸ¥è¯¢æ‹†è§£ (Decomposition)                  â”‚
â”‚  - æŸ¥è¯¢æ‰©å±• (Expansion)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       æ··åˆæ£€ç´¢ (Hybrid Retrieval)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  è¯­ä¹‰æ£€ç´¢ (70%)  â”‚  BM25æ£€ç´¢ (30%)  â”‚    â”‚
â”‚  â”‚  Semantic Search â”‚  Keyword Search  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â†“ åˆæ£€ Top-20 å€™é€‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Rerank (Cross-Encoder)              â”‚
â”‚  - BGE-Reranker-Base                         â”‚
â”‚  - é‡æ’åº Top-20 â†’ Top-4                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç”Ÿæˆç­”æ¡ˆ (LLM Generation)            â”‚
â”‚  - GPT-3.5-turbo / GPT-4                     â”‚
â”‚  - å¸¦å¼•ç”¨çš„ç­”æ¡ˆç”Ÿæˆ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ç­”æ¡ˆ + å¼•ç”¨ (Answer + Citations)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ€§èƒ½ä¼˜åŒ–é…ç½®

### åœºæ™¯1: é«˜å‡†ç¡®ç‡æ¨¡å¼

è¿½æ±‚æœ€ä½³æ£€ç´¢è´¨é‡ï¼Œé€‚åˆå­¦æœ¯ç ”ç©¶ã€‚

```env
USE_RERANK=true
USE_HYBRID=true
USE_QUERY_REWRITE=true

HYBRID_ALPHA=0.7
RERANK_TOP_K=4
FETCH_K=20
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ£€ç´¢å‡†ç¡®ç‡ï¼š80%+
- å“åº”æ—¶é—´ï¼š2-3ç§’
- é€‚ç”¨åœºæ™¯ï¼šå­¦æœ¯è®ºæ–‡åˆ†æã€æ·±åº¦ç ”ç©¶

### åœºæ™¯2: å¹³è¡¡æ¨¡å¼

æ€§èƒ½å’Œè´¨é‡çš„å¹³è¡¡ï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨ã€‚

```env
USE_RERANK=true
USE_HYBRID=true
USE_QUERY_REWRITE=false

HYBRID_ALPHA=0.7
RERANK_TOP_K=4
FETCH_K=15
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ£€ç´¢å‡†ç¡®ç‡ï¼š75%+
- å“åº”æ—¶é—´ï¼š1-2ç§’
- é€‚ç”¨åœºæ™¯ï¼šæ—¥å¸¸æŸ¥è¯¢ã€å¿«é€Ÿæ£€ç´¢

### åœºæ™¯3: å¿«é€Ÿæ¨¡å¼

è¿½æ±‚é€Ÿåº¦ï¼Œé€‚åˆå¤§é‡æŸ¥è¯¢ã€‚

```env
USE_RERANK=false
USE_HYBRID=false
USE_QUERY_REWRITE=false

TOP_K=4
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ£€ç´¢å‡†ç¡®ç‡ï¼š65%+
- å“åº”æ—¶é—´ï¼š0.5-1ç§’
- é€‚ç”¨åœºæ™¯ï¼šå¿«é€Ÿæµè§ˆã€æ‰¹é‡å¤„ç†

---

## ç›‘æ§ä¸æ—¥å¿—

### æŸ¥çœ‹æ—¥å¿—

```bash
# Docker Compose
docker-compose logs -f

# Docker
docker logs -f rag-paper

# æœ¬åœ°å¼€å‘
tail -f logs/rag_system.log
```

### æ—¥å¿—çº§åˆ«

- `INFO`: æ­£å¸¸è¿è¡Œä¿¡æ¯
- `WARNING`: è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚Fallbackè§¦å‘ï¼‰
- `ERROR`: é”™è¯¯ä¿¡æ¯
- `DEBUG`: è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰

### æ—¥å¿—æ–‡ä»¶

```
logs/
â”œâ”€â”€ rag_system.log          # ç³»ç»Ÿä¸»æ—¥å¿—
â”œâ”€â”€ retrieval.log           # æ£€ç´¢æ—¥å¿—
â”œâ”€â”€ generation.log          # ç”Ÿæˆæ—¥å¿—
â””â”€â”€ performance.log         # æ€§èƒ½æ—¥å¿—
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: å®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**ï¼š`docker-compose up`æŠ¥é”™

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥`.env`æ–‡ä»¶æ˜¯å¦å­˜åœ¨
2. æ£€æŸ¥ç«¯å£8000æ˜¯å¦è¢«å ç”¨ï¼š`netstat -ano | findstr :8000`
3. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š`docker-compose logs`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä¿®æ”¹ç«¯å£
# ç¼–è¾‘docker-compose.ymlï¼Œå°†8000æ”¹ä¸ºå…¶ä»–ç«¯å£
ports:
  - "8001:8000"
```

### é—®é¢˜2: æ¨¡å‹ä¸‹è½½æ…¢

**ç—‡çŠ¶**ï¼šé¦–æ¬¡å¯åŠ¨æ—¶å¡åœ¨æ¨¡å‹ä¸‹è½½

**è§£å†³æ–¹æ¡ˆ1** - ä½¿ç”¨å›½å†…é•œåƒï¼š
```bash
# è®¾ç½®HuggingFaceé•œåƒ
export HF_ENDPOINT=https://hf-mirror.com
```

**è§£å†³æ–¹æ¡ˆ2** - é¢„ä¸‹è½½æ¨¡å‹ï¼š
```bash
# åœ¨æ„å»ºé•œåƒå‰ä¸‹è½½æ¨¡å‹
python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2')"
```

### é—®é¢˜3: å†…å­˜ä¸è¶³

**ç—‡çŠ¶**ï¼šå®¹å™¨é¢‘ç¹é‡å¯ï¼ŒOOMé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼šå¢åŠ Dockerå†…å­˜é™åˆ¶
```yaml
# docker-compose.yml
services:
  rag-paper:
    mem_limit: 4g
    mem_reservation: 2g
```

### é—®é¢˜4: ChromaDBé”å®š

**ç—‡çŠ¶**ï¼š`Database is locked`é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# åœæ­¢æ‰€æœ‰å®¹å™¨
docker-compose down

# åˆ é™¤é”æ–‡ä»¶
rm -f chroma_db/*.lock

# é‡æ–°å¯åŠ¨
docker-compose up -d
```

---

## å‡çº§ä¸ç»´æŠ¤

### æ›´æ–°ä»£ç 

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# é‡æ–°æ„å»ºé•œåƒ
docker-compose build

# é‡å¯æœåŠ¡
docker-compose up -d
```

### å¤‡ä»½æ•°æ®

```bash
# å¤‡ä»½å‘é‡æ•°æ®åº“
tar -czf chroma_db_backup_$(date +%Y%m%d).tar.gz chroma_db/

# å¤‡ä»½PDFæ–‡ä»¶
tar -czf data_backup_$(date +%Y%m%d).tar.gz data/
```

### æ¸…ç†èµ„æº

```bash
# æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a

# æ¸…ç†æœªä½¿ç”¨çš„å·
docker volume prune

# å®Œå…¨æ¸…ç†ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
docker-compose down -v
```

---

## ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. å®‰å…¨é…ç½®

- ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œä¸è¦ç¡¬ç¼–ç APIå¯†é’¥
- ä½¿ç”¨Docker secretsç®¡ç†å¯†é’¥
- é™åˆ¶å®¹å™¨æƒé™ï¼š`--read-only`, `--security-opt`

### 2. æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨SSDå­˜å‚¨ChromaDBæ•°æ®
- é…ç½®é€‚å½“çš„å†…å­˜é™åˆ¶ï¼ˆå»ºè®®4GB+ï¼‰
- ä½¿ç”¨Nginxåå‘ä»£ç†
- å¯ç”¨ç¼“å­˜æœºåˆ¶

### 3. é«˜å¯ç”¨æ€§

- ä½¿ç”¨Docker Swarmæˆ–Kubernetesç¼–æ’
- é…ç½®å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡å¯
- éƒ¨ç½²å¤šä¸ªå‰¯æœ¬å®ç°è´Ÿè½½å‡è¡¡
- å®šæœŸå¤‡ä»½æ•°æ®

### 4. ç›‘æ§å‘Šè­¦

- é›†æˆPrometheusç›‘æ§
- é…ç½®Grafanaä»ªè¡¨æ¿
- è®¾ç½®å‘Šè­¦è§„åˆ™ï¼ˆCPUã€å†…å­˜ã€é”™è¯¯ç‡ï¼‰

---

## å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# ========== Docker Compose ==========
docker-compose up -d              # å¯åŠ¨æœåŠ¡
docker-compose down               # åœæ­¢æœåŠ¡
docker-compose logs -f            # æŸ¥çœ‹æ—¥å¿—
docker-compose ps                 # æŸ¥çœ‹çŠ¶æ€
docker-compose restart            # é‡å¯æœåŠ¡
docker-compose build              # é‡æ–°æ„å»º

# ========== Docker ==========
docker ps                         # æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
docker images                     # æŸ¥çœ‹é•œåƒ
docker exec -it rag-paper bash    # è¿›å…¥å®¹å™¨
docker stats                      # æŸ¥çœ‹èµ„æºä½¿ç”¨

# ========== ç³»ç»Ÿ ==========
python demo_multi_papers.py       # æ„å»ºç´¢å¼•
python main.py                    # å¯åŠ¨ç³»ç»Ÿ
python test_hybrid.py             # æµ‹è¯•æ··åˆæ£€ç´¢
python demo_evaluation_simple.py  # è¯„ä¼°ç³»ç»Ÿ
```

---

**éƒ¨ç½²å®Œæˆï¼** ğŸ‰

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒæ•…éšœæ’æŸ¥éƒ¨åˆ†æˆ–æäº¤Issueã€‚
